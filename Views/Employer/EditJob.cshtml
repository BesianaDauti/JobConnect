@model JobConnect.DTOs.JobUpdateDto

@{
    ViewData["Title"] = "Edit Job";
}

<div class="container mt-5 edit-job-container">
    <h2 class="mb-4 text-center">Edit Job</h2>

    <form id="editJobForm" method="post">

        <input type="hidden" asp-for="JobId" />

        <div class="mb-3">
            <label class="form-label">Job Title</label>
            <input asp-for="Title" class="form-control" required />
        </div>

        <div class="mb-3">
            <label class="form-label">Location</label>
            <input asp-for="Location" class="form-control" required />
        </div>

        <div class="mb-3">
            <label class="form-label">Job Type</label>
            <input asp-for="JobType" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Salary</label>
            <input asp-for="Salary" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Working Hours</label>
            <input asp-for="WorkingHours" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Experience Level</label>
            <input asp-for="ExperienceLevel" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Positions Available</label>
            <input asp-for="PositionsAvailable" class="form-control" type="number" min="1" />
        </div>

        <div class="mb-3">
            <label class="form-label">Deadline</label>
            <input asp-for="Deadline" class="form-control" type="date" />
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea asp-for="Description" rows="4" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Requirements</label>
            <textarea asp-for="Requirements" rows="4" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Responsibilities</label>
            <textarea asp-for="Responsibilities" rows="4" class="form-control"></textarea>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="@Url.Action("Jobs", "Employer")" class="btn btn-secondary">← Back</a>

            <div>
                <button type="button" class="btn btn-danger me-2" id="deleteJobBtn">Delete</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </div>


    </form>
</div>
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="successModalBody"></div>
        </div>
    </div>
</div>
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="errorModalBody"></div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this job?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
            const editJobForm = document.getElementById("editJobForm");

        if (editJobForm) {

            editJobForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                const formData = new FormData(editJobForm);

                try {
                    const response = await fetch("/Employer/EditJob", {
                        method: "POST",
                        body: formData
                    });

                    let text = await response.text();
                    let result;

                    try {
                        result = JSON.parse(text);
                    } catch {
                        result = { success: false, message: "Unexpected response" };
                    }

                    console.log("Server result:", result);

                    if (response.ok && result.success) {
                        document.getElementById("successModalBody").innerText = result.message;
                        new bootstrap.Modal(document.getElementById("successModal")).show();

                        setTimeout(() => {
                            window.location.href = result.redirect;
                        }, 1500);

                    } else {
                        document.getElementById("errorModalBody").innerText =
                            result.message || "Error updating job";
                        new bootstrap.Modal(document.getElementById("errorModal")).show();
                    }

                } catch (err) {
                    console.error("NETWORK ERROR:", err);
                    document.getElementById("errorModalBody").innerText = "Network error!";
                    new bootstrap.Modal(document.getElementById("errorModal")).show();
                }
            });
        }
        else {
            console.log("Edit Job form NOT FOUND!");
        }
        const deleteJobBtn = document.getElementById("deleteJobBtn");
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
        const jobIdInput = document.querySelector("input[name='JobId']");

        if (deleteJobBtn && confirmDeleteBtn && jobIdInput) {

            const confirmModalEl = document.getElementById("confirmDeleteModal");
            const confirmModal = bootstrap.Modal.getOrCreateInstance(confirmModalEl);

            deleteJobBtn.addEventListener("click", () => {
                confirmModal.show();
            });

            confirmDeleteBtn.addEventListener("click", async () => {
                confirmDeleteBtn.disabled = true;

                const formData = new FormData();
                formData.append("jobId", jobIdInput.value);

                try {
                    const response = await fetch("/Employer/DeleteJob", {
                        method: "POST",
                        body: formData
                    });

                    let result = {};
                    try {
                        result = await response.json();
                    } catch {
                        result = { success: false, message: "Unexpected server response." };
                    }

                    if (response.ok && result.success) {

                        confirmModal.hide();

                        setTimeout(() => {
                            showSuccess(result.message, result.redirect);
                        }, 300);

                    } else {
                        showError(result.message || "Error deleting job.");
                    }

                } catch (err) {
                    showError("Network error. Please try again.");
                } finally {
                    confirmDeleteBtn.disabled = false;
                }
            });
        }

        function showSuccess(message, redirectUrl) {
            document.getElementById("successModalBody").innerText = message;

            const successModal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById("successModal")
            );
            successModal.show();

            if (redirectUrl) {
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            }
        }

        function showError(message) {
            document.getElementById("errorModalBody").innerText = message;

            const errorModal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById("errorModal")
            );
            errorModal.show();
        }
    </script>
}