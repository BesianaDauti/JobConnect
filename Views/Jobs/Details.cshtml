@model JobConnect.Models.Job

@{
    ViewData["Title"] = "Job Details";

    string Display(string? text) =>
        string.IsNullOrWhiteSpace(text) ? "Not provided" : text;
}


<div class="container py-5">
    <div class="mb-3">
        <button class="btn btn-outline-secondary" onclick="history.back()">
            ← Back
        </button>
    </div>

    <div class="card shadow-lg p-4 job-details-card">
        <h2 class="mb-3">@Model.Title</h2>

        <p><strong>Company:</strong> @Model.CompanyName</p>
        <p><strong>Location:</strong> @Model.Location</p>
        <p><strong>Working Hours:</strong> @Display(Model.WorkingHours)</p>
        <p><strong>Salary:</strong> @Display(Model.Salary)</p>
        <p><strong>Experience Required:</strong> @Display(Model.ExperienceLevel)</p>
        <p><strong>Job Type:</strong> @Model.JobType</p>
        <p><strong>Posted At:</strong> @Model.PostedAt.ToShortDateString()</p>
        <p><strong>Deadline:</strong> @Model.Deadline.ToShortDateString()</p>

        <hr>

        <h4>Description</h4>
        <p>@Display(Model.Description)</p>

        <hr>

        <h4>Responsibilities</h4>
        <p>@Html.Raw(Display(Model.Responsibilities))</p>

        <hr>

        <h4>Requirements</h4>
        <p>@Html.Raw(Display(Model.Requirements))</p>

        <button class="btn btn-primary px-4 apply-btn"
                data-job-id="@Model.JobId">
            Apply Now
        </button>
    </div>
</div>
<div class="modal fade" id="loginRequiredModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Login Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                You must be logged in as a <strong>Job Seeker</strong> to apply for this job.
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a href="/Accounts/Login" class="btn btn-primary">Login</a>
                <a href="/Accounts/Register" class="btn btn-secondary">Register</a>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Success</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="successModalBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="errorModalBody"></div>
        </div>
    </div>
</div>
<style>
    #loginRequiredModal .modal-content {
        border-radius: 16px;
        border: none;
        background: var(--white);
        box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        animation: fadeDown 0.25s ease-out;
    }

    #loginRequiredModal .modal-header {
        background: var(--c2);
        color: var(--white);
        border-radius: 16px 16px 0 0;
        padding: 1rem 1.5rem;
    }

    #loginRequiredModal .modal-body {
        padding: 1.4rem;
        font-size: 1.05rem;
        color: var(--c1);
        text-align: center;
    }

    #loginRequiredModal .btn-primary {
        background: var(--c5);
        border: none;
    }

        #loginRequiredModal .btn-primary:hover {
            background: var(--c2);
        }

    #loginRequiredModal .btn-secondary {
        background: var(--c1);
        color: var(--white);
        border: none;
    }

        #loginRequiredModal .btn-secondary:hover {
            background: var(--c2);
        }

    #loginRequiredModal .btn-close {
        filter: brightness(0) invert(1);
    }
</style>


@section Scripts {
    <script>
                document.addEventListener("DOMContentLoaded", () => {

            const applyButtons = document.querySelectorAll(".apply-btn");

            applyButtons.forEach(btn => {
                btn.addEventListener("click", async () => {

                    const jobId = btn.getAttribute("data-job-id");

                    const response = await fetch(`/Jobs/ApplyCheck?jobId=${jobId}`);
                    const result = await response.json();

                    if (!response.ok || !result.isJobSeeker) {
                        new bootstrap.Modal(document.getElementById("loginRequiredModal")).show();
                        return;
                    }

                    const applyResponse = await fetch(`/Jobs/Apply?jobId=${jobId}`, {
                        method: "POST"
                    });

                    const applyResult = await applyResponse.json();

                    if (applyResponse.ok && applyResult.success) {
                        document.getElementById("successModalBody").innerText = applyResult.message;
                        new bootstrap.Modal(document.getElementById("successModal")).show();
                    } else {
                        document.getElementById("errorModalBody").innerText = applyResult.message;
                        new bootstrap.Modal(document.getElementById("errorModal")).show();
                    }
                });
            });
        });

    </script>
}
